#!/bin/bash

set -x

appname=pytemplate
target_path=/opt/cmre/$appname
dot="$(cd "$(dirname "$0")"; pwd)"
build_root=$dot/build
build_home=$build_root$target_path
pip=$build_home/bin/pip

rm -rf $build_root 
mkdir -p $build_root

#--copies force do avoid symb links inside venv
python3 -m venv --copies $build_home 
$pip install --upgrade pip
$pip install -r requirements.txt
$pip install .
$pip uninstall -y pip

find $build_root -iname *.pyc -exec rm {} \;
find $build_root -iname *.pyo -exec rm {} \;

#remove absolute path
find $build_root -type f | xargs sed -i "s@$path@/opt@g"

#rm -f $appname*.rpm
fpm \
	-t rpm \
	-s dir \
	-n $appname \
	-C $build_root \
	--verbose \
	-d python36 \
	.

set +x
